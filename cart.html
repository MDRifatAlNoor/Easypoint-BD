<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Easypoint BD | Cart</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Montserrat',sans-serif;
  padding-top:80px;
  background:#f0f2f5;
}

/* NAVBAR */
.navbar{
  background:#0f172a;
  box-shadow:0 10px 25px rgba(0,0,0,.4);
}
.navbar-brand{
  font-weight:800;
  font-size:1.8rem;
  color:#ff416c!important;
}
.nav-link{
  color:#fff!important;
}
.nav-link:hover,
.nav-link.active{
  color:#ff416c!important;
}
.nav-link i {
  transition: transform 0.3s ease;
}
.nav-link:hover i {
  transform: translateY(-2px) scale(1.1);
}
@media (max-width: 991px) {
  .navbar { padding: 10px 15px; }
  .navbar-nav { background: #0f172a; border-radius: 15px; padding: 15px; margin-top: 10px; }
  .navbar-nav .nav-item { text-align: center; margin-bottom: 10px; }
  .navbar-nav .nav-link { font-size: 1.1rem; }
}

/* CART */
.cart-card{
  background:#fff;
  border-radius:15px;
  box-shadow:0 20px 40px rgba(0,0,0,.1);
}

/* FOOTER */
.footer{
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:#fff;
  padding:40px 0;
}
.footer a{
  color:#fff;
  transition:.3s;
}
.footer a:hover{
  color:#ffeb3b;
  transform:translateY(-4px);
}
</style>
</head>

<body class="d-flex flex-column min-vh-100">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow">
  <div class="container">
    <a class="navbar-brand" href="index.html">
      <i class="bi bi-bag-check-fill me-1"></i> Easypoint BD
    </a>
    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item">
          <a class="nav-link" href="index.html">
             Home
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="cart.html">
             Cart
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="checkout.html">
          Checkout
          </a>
        </li>
        <li class="nav-item"><a class="nav-link" href="account.html">Account</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- MAIN CONTENT -->
<main class="flex-grow-1">
  <div class="container my-5">
    <h2 class="fw-bold mb-4 text-center">Your Shopping Cart</h2>

    <div class="cart-card p-4">
      <div class="table-responsive">
  <table class="table align-middle text-center">
    <thead class="table-light">
      <tr>
        <th scope="col">Product</th>
        <th scope="col">Price</th>
        <th scope="col">Qty</th>
        <th scope="col">Total</th>
        <th scope="col">Note</th> <!-- Note column -->
        <th scope="col">Action</th> <!-- Remove button column -->
      </tr>
    </thead>
    <tbody id="cart-items">
      <!-- JS inject করবে cart items -->
    </tbody>
  </table>
</div>

      <div class="d-flex justify-content-between align-items-center mt-4">
        <h5 class="fw-bold">Grand Total: <span id="grand-total">0</span></h5>
        <a href="checkout.html" class="btn btn-primary px-4">Proceed to Checkout</a>
      </div>
    </div>
  </div>
  <div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="product-title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="product-img" src="" class="img-fluid rounded">
      </div>
    </div>
  </div>
</div>
</main>

<!-- FOOTER -->
<footer class="footer mt-auto">
  <div class="container text-center">
    <h5 class="fw-bold">Contact Us</h5>
    <div class="d-flex justify-content-center gap-4 my-3">
      <a href="#"><i class="bi bi-facebook fs-4"></i></a>
      <a href="#"><i class="bi bi-telegram fs-4"></i></a>
      <a href="#"><i class="bi bi-whatsapp fs-4"></i></a>
    </div>
    <p class="mb-0 opacity-75">&copy; Easypoint BD. All rights reserved.</p>
  </div>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase + Cart JS -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyApZK1uKspkk_yu8mCKDH44rDnmJzjvv00",
    authDomain: "myshop-f7a03.firebaseapp.com",
    projectId: "myshop-f7a03",
    storageBucket: "myshop-f7a03.appspot.com",
    messagingSenderId: "793564064034",
    appId: "1:793564064034:web:fcc5230ff28a5ee8005d7b"
  };
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  // Persist login session
  setPersistence(auth, browserLocalPersistence);
  
  // Elements
  const cartItems = document.getElementById("cart-items");
  const grandTotalEl = document.getElementById("grand-total");
  
  // Helper function to format price
  function formatPrice(num) {
    return Number.isInteger(num) ? num : num.toFixed(2);
  }
  
  // Save cart to Firebase
  async function saveCartToFirebase(userId, cart) {
    try {
      await setDoc(doc(db, "users", userId), { cart }, { merge: true });
      console.log("Cart saved to Firebase");
    } catch (err) {
      console.error("Error saving cart:", err);
    }
  }
  
  // Auth check
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "signin.html"; // redirect if not logged in
    } else {
      renderCart(user.uid);
    }
  });
  
  // Render cart items
  function renderCart(userId) {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    cartItems.innerHTML = "";
    let grandTotal = 0;
    
    if (cart.length === 0) {
      cartItems.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-4 text-muted">
            Your cart is empty.
          </td>
        </tr>
      `;
      grandTotalEl.textContent = "৳0";
      return;
    }
    
    cart.forEach((item, index) => {
      const total = item.price * item.quantity;
      grandTotal += total;
      
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>
          <img src="${item.image}" alt="${item.name}" style="width:60px; height:60px; object-fit:cover; border-radius:8px; margin-right:10px;">
          <span style="cursor:pointer; color:#0d6efd;" onclick="showProduct('${item.name}','${encodeURIComponent(item.image)}')">
            ${item.name}
          </span>
        </td>
        <td>৳${formatPrice(item.price)}</td>
        <td>
          <input type="number" min="1" value="${item.quantity}" class="form-control quantity-input" style="width:80px">
        </td>
        <td>৳${formatPrice(total)}</td>
        <td>
          <input type="text" placeholder="Add note (size, color, etc)" class="form-control note-input" value="${item.note || ''}" style="width:150px;">
        </td>
        <td>
          <button class="btn btn-sm btn-danger remove-btn">Remove</button>
        </td>
      `;
      
      // Quantity change
      row.querySelector(".quantity-input").addEventListener("change", (e) => {
        let val = parseInt(e.target.value);
        if (isNaN(val) || val < 1) val = 1;
        cart[index].quantity = val;
        localStorage.setItem("cart", JSON.stringify(cart));
        saveCartToFirebase(userId, cart); // save to Firebase
        renderCart(userId);
      });
      
      // Note input change
      row.querySelector(".note-input").addEventListener("input", (e) => {
        cart[index].note = e.target.value;
        localStorage.setItem("cart", JSON.stringify(cart));
        saveCartToFirebase(userId, cart); // save note to Firebase
      });
      
      // Remove item
      row.querySelector(".remove-btn").addEventListener("click", () => {
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        saveCartToFirebase(userId, cart); // update Firebase
        renderCart(userId);
      });
      
      cartItems.appendChild(row);
    });
    
    grandTotalEl.textContent = `৳${formatPrice(grandTotal)}`;
  }
  
  // Show product modal
  window.showProduct = function(name, img) {
    const modalImg = document.getElementById('product-img');
    const modalTitle = document.getElementById('product-title');
    modalImg.src = decodeURIComponent(img);
    modalTitle.textContent = name;
    
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
  };
</script>
</body>
</html>